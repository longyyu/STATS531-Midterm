---
title: "An Analysis of Lake Michigan-Huron Water Levels"
author: "Eric Chen, Yanyu Long"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_depth: 2
subtitle: STATS 531 Midterm Project (W21)
---

------------

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	warning = FALSE,
	message = FALSE,
	include = TRUE,
	comment='',
	fig.align = "center"
)
```


```{css, include = TRUE, echo = FALSE}
body{ /* Normal */
  font-size: 15px;
}
span.math{ /* Formulas */
  font-size: 14px;
}
pre { /* Scrollable code block */
  max-height: 250px;
  overflow-y: auto;
}
.comment { /* Comments, to be deleted later */
  margin: 30px;
  padding-left: 10px;
  color: Darkred;
  border-left-style: solid;
  border-color: #f2f2f2;
  font-weight: 600;
}
```

```{r, echo = FALSE}
opar = par()
library(tidyverse)
library(kableExtra)

generate_aic_table=function(data, P, Q, D=0, ...){
	table=matrix(NA, (P+1), (Q+1))
	for(p in 0:P) {
		for(q in 0:Q) {
		  model_aic = try(
		    arima(data, order = c(p, D, q), method="ML", ...)$aic, 
		    silent = TRUE
		  )
		  table[p + 1,q + 1] = ifelse(
		    inherits(model_aic, "try-error"), NA, model_aic
		  )
		}
	}
	dimnames(table) = list(paste("AR", 0:P, sep=""), paste("MA", 0:Q, sep=""))
  table
}

format_aic_tables = function(table, ...) {
  min_idx = which(table == min(table, na.rm = TRUE), arr.ind = TRUE)
  table %>% 
    knitr::kable(
      format = "html", digits = 2, escape = TRUE, ...
    ) %>%
    row_spec(row = 0, align = 'c') %>%
    column_spec(column = 1, bold = TRUE) %>%
    kable_styling("striped", full_width = FALSE) %>%
    add_footnote(sprintf(
      "Model with the lowest AIC: %s %s, AIC = %4.2f\n",
      rownames(table)[min_idx[1, 1]], colnames(table)[min_idx[1, 2]],
      min(table, na.rm = TRUE)
    ))
}

generate_acf_qqplot = function(model) {
  par(mfrow = c(1, 2))
  acf(model$resid, na.action = na.pass, 
      main = "Autocorrelation function\nestimation")
  qqnorm(as.numeric(model$resid))
  qqline(as.numeric(model$resid))
  par(opar)
}
```

## Outline

[Q: Do we want to drop the observation in January 2021?]{.comment}

[DELETE THIS WHEN FINISHED!]{.comment}

- 1) [Eric - **DONE**] introduction and motivation

- 2) [Yanyu - **DONE**] plot the data, describe the data

- 3) fitting an ARMA model
  - [Eric - **DONE**] check for a trend
  - [Eric - **DONE**] check for seasonality
    - spectrogram
    - trend + noise + cycles decomposition
  - [Eric - **DONE**] pick appropriate model class (SARMA if there is seasonality, ARIMA if there is a trend, etc.)
  
  - [Yanyu] AIC table
  - [Yanyu] goodness of fit
    - residual plot
    - ACF of residuals
    - QQ-plot / Shapiro-Wilk test for normality
  
  - [Yanyu] investigate roots
  - [Yanyu] profile likelihood?
  - [Yanyu] chi-squared test for nested models?
  
- 4) [Eric] investigate how other lakes can act as predictor for Lake Michigan
  - motivation: is there a lag in the warmer lake (Erie) that can be used for prediction? Warmer lakes may be more susceptible to climactic changes
  - [Yanyu - **DONE(?)**] plot the data, describe the data
  - cross-spectrum, cross-correlation, coherency
  - linear regression with ARMA errors 
    - goodness of fit analysis, likelihood-ratio tests, etc.
  - conduct subset of analyses from (2) on Lake Erie data
    - fit model from (2)
    - run some diagnostics / goodness-of-fit
    
- 5) [Eric] conclusion

------------

## Introduction

The Great Lakes are a major source of water, recreation, and industry for over 30 million people, including most Michigan residents. However, in recent years, there has been a growing concern over steadily rising water levels: news sources such as the [Green Bay Press-Gazette](https://www.greenbaypressgazette.com/story/news/local/oconto-county/2020/08/04/lake-michigan-breaks-34-year-old-high-water-record/3294377001/), the [Detroit Free Press](https://www.freep.com/story/news/local/michigan/2020/07/17/great-lakes-water-levels-records-erosion-damage/5450910002/), and [The Washington Post](https://www.washingtonpost.com/weather/2019/11/08/great-lakes-water-levels-have-swung-record-lows-record-highs-heres-why/) have reported on the resulting property damage, shoreline erosion, and economic disruption. As such, environmental scientists have been investigating the potential causes and implications of high water in the Great Lakes, tying this into the larger conversation about climate change. 

In this project, we consider the variation of water levels in Lake Michigan-Huron over the time period 1980-2021, given that the majority of residents in the Great Lakes watershed live by Lake Michigan. Our goal is to identify if there is indeed a noticeable increase in water levels in the past 30 years, and to describe any other patterns that may be of interest to environmental scientists and climatologists. In addition, we may want to study how the water levels in one lake may be associated with the water levels in another lake; thus, we will cross-compare water levels between Lake Michigan and Lake Erie, the warmest Great Lake.

----

**NB**: Lake Michigan and Lake Huron are hydrologically [one lake](https://en.wikipedia.org/wiki/Lake_Michigan%E2%80%93Huron), since the flow of water through the Straits of Mackinac keeps their respective water levels in near-equilibrium. 

------------

## Data

The data consists of monthly lake level means and was collected by the [Center for Operational Oceanographic Products and Services](https://tidesandcurrents.noaa.gov/map/index.html?region=Lake%20Michigan) (CO-OPS), an arm of the National Oceanic and Atmospheric Administration (NOAA).  

```{r echo=FALSE}
## reading in and formatting data
data_huron = read.csv('michigan_huron.csv', colClasses = list(Date = "Date")) %>%
  rename_with(~ str_extract(.x, "([[:alpha:]]+)")) %>% # get rid of `.` in colnames
  select(Date, MSL)
level = data_huron$MSL
```


```{r, echo=FALSE, fig.width=8, fig.height=4}
date_breaks = with(data_huron, seq.Date(from = min(Date), to = max(Date), by = '5 years'))

peak_trough = rbind(
  data_huron %>% filter(Date<as.Date("1990-01-01")) %>% filter(MSL==max(MSL)),
  data_huron %>% filter(Date>as.Date("1990-01-01"), Date<as.Date("2000-01-01")) %>% filter(MSL==max(MSL)),
  data_huron %>% filter(Date>as.Date("2010-01-01")) %>% filter(MSL==min(MSL))
)

data_huron %>%
  ggplot(aes(Date, MSL)) + 
    theme_bw() +
    geom_line(color="#69b3a2", size=1) +
    ylab("Mean Lake Level (ft)") +
    ggtitle('Lake Michigan-Huron Water Levels, 1980-2021') +
    scale_x_date(breaks=date_breaks, date_labels='%Y') +
    geom_vline(data=peak_trough, aes(xintercept=Date), 
               color="darkred", linetype="dashed", alpha=.4) +
    theme(plot.title=element_text(hjust=0.5))
```

------------

## Exploratory Data Analysis

The water levels of Lake Michigan-Huron had two noticeable peaks in October 1986 and July 1997, a dip around the years 2000-2013, followed by a sharp rise; there does seem to be some evidence of a nonlinear trend. In addition, we see evidence of cyclical behavior with period ~10 years from 1980-2000 -- we will examine this more closely in the "Seasonality" section.

More concretely, let's look at the sample autocorrelation function (ACF) to see if our intuition is correct, and to test if a stationary time series model would be appropriate.

```{r, echo=FALSE, fig.width=5, fig.height=3.5}
acf(level, main="Sample autocorrelation function")
```

There is significant evidence for non-stationarity in the data! The gradual decrease in the ACF suggests that there is an systematic trend in the data, and the periodic behavior suggests that seasonality is also present. As such, we will likely want to fit a model with trend and seasonality. 

### Trend 

Before we examine seasonality, we will want to detrend our data. Looking at our data, anything less than a quadratic fit is likely to be underfitting, but we should be careful about overfitting as well. Therefore, we compute the AIC values for polynomial regression models of degree up to 5, where time is our  regressor. 

More formally, let $t$ represent time, and let $Y_n$ be our data generating process. Then we are comparing models of the form 

$$
Y_n = \sum\limits_{j=0}^{d}\beta_j t^j,\ \ d \in [5].
$$

```{r echo=FALSE}
date_num = seq(from = 1980, length = nrow(data_huron), by = 1/12)

table=matrix(NA, 5, 1)
for(i in 1:5) {
  model_aic = try(
    AIC(lm(level ~ poly(date_num, i))), 
    silent = TRUE
  )
  table[i, 1] = ifelse(
    inherits(model_aic, "try-error"), NA, model_aic
  )
}
dimnames(table) = list(paste("degree ", 1:5, ': ', sep=""))

table %>%
  kbl(format='html', digits=2, escape=FALSE, caption='<center style=\'color:black\'><strong>AIC values</strong></center>') %>%
  kable_styling("striped", full_width = FALSE)
```

The lowest AIC value is attained by the quartic fit; however, plotting the cubic and quartic lines of best fit indicate that they are quite close, so we will remain parsimonious and select the cubic function to model our trend.

```{r echo=FALSE, fig.width=8, fig.height=4}
data_huron %>%
  ggplot(aes(Date, MSL)) +
    theme_bw() +
    geom_line(color="#69b3a2", size=1) +
    ggtitle('Lake Michigan-Huron Water Levels, 1980-2021') +
    ylab("Mean Lake Level (ft)") +
    scale_x_date(breaks=date_breaks, date_labels='%Y') +
    geom_smooth(size=1, method="lm", formula=y~poly(x, 3), 
                aes(color="cubic fit", fill="cubic fit")) +
    geom_smooth(size=1, method="lm", formula=y~poly(x, 4), 
                aes(color="quartic fit", fill="quartic fit")) +
    scale_colour_manual(name="Fitted values", values=c("#96BCFF", "#FC948D")) +
    scale_fill_manual(name="Fitted values", values=c("#96BCFF", "#FC948D")) +
    theme(plot.title=element_text(hjust=0.5))
```

Looking at the model residuals, there seems to be only periodic behavior left to analyze; thus we continue with our analysis on seasonality.

```{r echo=FALSE, fig.width=6, fig.height=3}
data_huron %>%
  mutate(Residuals = lm(level ~ poly(date_num, 3))$residuals) %>%
  ggplot(aes(Date, Residuals)) +
    theme_bw() +
    geom_line(size=1, color="#69b3a2") +
    ggtitle('Residuals') +
    scale_x_date(breaks=date_breaks, date_labels='%Y') +
    theme(plot.title=element_text(hjust=0.5))
```

### Seasonality

Now, let's further examine the data by decomposing the time series into trend, seasonality, and noise components. Our prior knowledge should inform us that lake levels tend to be higher in early summer and lower in winter due to increased runoff and precipitation in spring.  

```{r, echo=FALSE, fig.width = 6, fig.height = 5}
stl(ts(level, start = c(1980, 2), frequency=12), s.window = 'periodic', t.window=50) %>% plot(main='Decomposition Of Lake Levels')
```

There appears to be short-term cyclical behavior with period 1 year, which matches with our intuition. In order to identify such seasonality more concretely, let us approximate the spectral density function of the detrended data by using a smoothed periodogram to remove noise.

```{r, echo=FALSE, fig.width=6, fig.height=4}
model <- lm(level ~ poly(date_num, 3))
smoothed <- spectrum(model$residuals, spans=c(5, 5, 5), main="Periodogram (Smoothed)")

idx_max <- which.max(smoothed$spec)
idx_max2 <- which.max(smoothed$spec[20:length(smoothed$spec)]) + 19
idx_max3 <- which.max(smoothed$spec[50:length(smoothed$spec)]) + 49

abline(v=smoothed$freq[idx_max], lty=2, col='red')
abline(v=smoothed$freq[idx_max2], lty=2, col='red')
abline(v=smoothed$freq[idx_max3], lty=2, col='gray')

paste0('local maximum 1: ', smoothed$freq[idx_max])
paste0('local maximum 2: ', smoothed$freq[idx_max2])
paste0('local maximum 3: ', smoothed$freq[idx_max3])
```

There seem to be a couple of dominant frequencies. The first is $\omega_1 = 0.01$, which corresponds to a period of $1 / 0.01 = 100$ months, or about $8.33$ years. This seems to correspond to the the longer-term variation of around 10 years as described above. However, the peak is not "sharp" and so this may simply be due to natural variation.

There is also a noticeable maximum at around $\omega_2 = 0.084$, which corresponds to a much shorter period of $1 / 0.084 \approx 12$ months or $1$ year. (There is another local maximum at around $0.166$; however, this corresponds to the second harmonic of $\omega_2$, so we can ignore this.) This fits in with our domain knowledge, so we wil include this in our model fitting below.

## Model Selection

Given our analyses above, we find it appropriate to conduct a regression with ARMA errors, where the regressor is a cubic function of time, and the errors are modeled with an SARMA process. 


## Model Diagnostics

```{r, echo=FALSE, eval=FALSE}
generate_aic_table(level, P=5, Q=5, D=0, xreg = poly(date_num, 3)) %>%
  format_aic_tables(caption = "AIC of $\\mathrm{ARMA}(p, q)$ models, $0 \\leq p, q \\leq 5$")
```

```{r, echo=FALSE, eval=FALSE}
generate_aic_table(
  level, P=5, Q=5, D=0, xreg = poly(date_num, 3),
  seasonal = list(order = c(1, 0, 0), period = 12)
) %>%
  format_aic_tables(caption = "AIC of $\\mathrm{SARMA}(p, q) \\times (1, 0)_{12}$ models, $0 \\leq p, q \\leq 5$")
```

```{r, echo=FALSE, eval=FALSE}
generate_aic_table(
  level, P=5, Q=5, D=0, xreg = poly(date_num, 3),
  seasonal = list(order = c(0, 0, 1), period = 12)
) %>%
  format_aic_tables(caption = "AIC of $\\mathrm{SARMA}(p, q) \\times (0, 1)_{12}$ models, $0 \\leq p, q \\leq 5$")
```

Although the lowest AIC is given by $SARMA(5,2)\times(1,1)_{12}$, the $SARMA(3,0)\times(1,1)_{12}$ and $SARMA(2,0)\times(1,1)_{12}$ models have very similar performance and fewer parameters. Therefore, we will consider the two simpler models in the following analysis. 


```{r}
m30_11 = arima(level, c(3, 0, 0), xreg = poly(date_num, 3), 
               seasonal = list(order = c(1, 0, 1), period = 12), method='ML')

m20_11 = arima(level, c(2, 0, 0), xreg = poly(date_num, 3), 
               seasonal = list(order = c(1, 0, 1), period = 12), method='ML')
```

The residuals of both models show no striking patterns, no significant signs of autocorrelation, and look like they are normally distributed. 

#### Residuals of the $SARMA(3, 0) \times (1, 1)_{12}$ model

```{r, echo=FALSE, cache=TRUE}
generate_aic_table(
  level, P=5, Q=5, D=0, xreg = poly(date_num, 3),
  seasonal = list(order = c(1, 0, 1), period = 12)
) %>%
  format_aic_tables(caption = "AIC of $\\mathrm{SARMA}(p, q) \\times (1, 1)_{12}$ models, $0 \\leq p, q \\leq 5$")
```


```{r echo=FALSE, fig.width = 6, fig.height = 3}
generate_acf_qqplot(m30_11)
#! TODO: add unit root test
```

#### Residuals of the $SARMA(2, 0) \times (1, 1)_{12}$ model

```{r echo=FALSE, fig.width = 6, fig.height = 3, fig.cap="$SARMA(2,0)\\times(1,1)_{12}$ residual plot"}
data_huron %>%
  mutate(Residuals = m20_11$residuals) %>%
  ggplot(aes(Date, Residuals)) +
    theme_bw() +
    geom_line(size=.5, color="#69b3a2") +
    scale_x_date(breaks=date_breaks, date_labels='%Y') +
    theme(plot.title=element_text(hjust=0.5))
```

```{r echo=FALSE, fig.width = 6, fig.height = 3}
generate_acf_qqplot(m20_11)
params = m20_11$coef
#! TODO: add unit root test
```

[TODO: Add unit root test]{.comment}  

Comparing the estimated coefficients of the two models, we can see that the `ar3` estimate is close to zero and on the edge of statistically significance in terms of the Fisher information. This motivates us to conduct a profile likelihood estimation to further check the confidence interval. 

```{r}
tibble(
  model="SARMA(3,0)x(1,1)", Term = names(m30_11$coef), 
  est = sprintf("%4.3f (%4.3f)", m30_11$coef, sqrt(diag(m30_11$var.coef)))
) %>%
  rbind(
    tibble(
      model="SARMA(2,0)x(1,1)", Term = names(m20_11$coef), 
      est = sprintf("%4.3f (%4.3f)", m20_11$coef, sqrt(diag(m20_11$var.coef)))
    )
  ) %>%
  pivot_wider(id_cols = Term, names_from = model, values_from = est) %>%
  knitr::kable(caption = "Coefficient estimates (s.e.)") %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```


[Profile log likelihood does not work well (too many NA values)]{.comment}  

```{r, cache=TRUE}
K = 100
ar3 = seq(-0.8, -0.01, length.out = K)
profile_loglik = numeric(K)
for (k in 1:K) {
  loglik_k = try(
    logLik(
      arima(level, c(3, 0, 0), xreg = poly(date_num, 3), 
            seasonal = list(order = c(1, 0, 1), period = 12), method='ML',
            fixed = c(NA, NA, ar3[k], NA, NA, NA, NA, NA, NA))
    ), silent = TRUE
  )
  profile_loglik[k] = ifelse(inherits(loglik_k, "try-error"), NA, loglik_k)
}
```

```{r, fig.width=6, fig.height=3}
profile_loglik %>% is.na() %>% sum()
profile_loglik %>% range(na.rm = TRUE)
plot(profile_loglik ~ ar3, type = "l")
```

Finally, we will do a hypothesis test with the Wilk's approximation, with the null hypothesis $H^{<0>}$ corresponding to the $SARMA(2, 0)\times(1, 1)_{12}$ model, and the alternative $H^{<1>}$ corresponding to the $SARMA(3, 0)\times(1, 1)_{12}$ model. 
The difference in the log likelihood $\Delta = (l_1 - l_0) \approx `r sprintf("%4.3f", m30_11$loglik - m20_11$loglik)` > \frac{\chi^2_{0.95, DF = 1}}{2} = `r sprintf("%4.3f", qchisq(0.95, df = 1)/2)`$. Therefore, we can reject $H^{<0>}$ at the 5% confidence level - the $SARMA(3, 0)\times(1, 1)_{12}$ model is more appropriate for the data. 

```{r echo=FALSE, fig.width = 6, fig.height = 3, fig.cap="$SARMA(3,0)\\times(1,1)_{12}$ residual plot"}
data_huron %>%
  mutate(Residuals = m30_11$residuals) %>%
  ggplot(aes(Date, Residuals)) +
    theme_bw() +
    geom_line(size=.5, color="#69b3a2") +
    scale_x_date(breaks=date_breaks, date_labels='%Y') +
    theme(plot.title=element_text(hjust=0.5))
```

------------

## Cross-Comparison  

[Need some transitional sentences here. ]{.comment}  

[Below is the EDA of Lake Erie's data. Feel free to use/drop them however you see fit. ]{.comment}

```{r, echo=FALSE}
data_erie = read.csv("erie.csv", colClasses = list(Date = "Date")) %>%
  rename_with(~ str_extract(.x, "([[:alpha:]]+)")) %>% # get rid of `.` in colnames
  select(c("Date", "MSL"))
```

The water levels of Lake Erie peaked in June 1986 and June 1997, and has presented a steady upward trend since 2010. 

```{r, echo=FALSE, fig.width=8, fig.height=3.5}
peak_trough = rbind(
  data_erie %>% filter(Date<as.Date("1990-01-01")) %>% filter(MSL==max(MSL)),
  data_erie %>% filter(Date>as.Date("1990-01-01"), Date<as.Date("2000-01-01")) %>% filter(MSL==max(MSL)),
  data_erie %>% filter(Date>as.Date("2010-01-01")) %>% filter(MSL==min(MSL))
)

data_erie %>%
  ggplot(aes(Date, MSL)) + 
    theme_bw() +
    geom_line(color="#69b3a2", size=1) +
    ylab("Mean Lake Level (ft)") +
    ggtitle("Lake Erie Water Levels, 1980-2021") +
    scale_x_date(breaks=date_breaks, date_labels='%Y') +
    geom_vline(data=peak_trough, aes(xintercept=Date), 
               color="darkred", linetype="dashed", alpha=.4) +
    theme(plot.title=element_text(hjust=0.5))
```

Plotting the centered water levels of Lake Erie and lake Michigan-Huron together, we can see that the two sets of data present a similar overall trend. 

```{r, echo=FALSE, fig.width=8, fig.height=3.5}
ggplot() + 
  theme_bw() +
  geom_line(data=data_erie, 
            aes(Date, MSL-mean(MSL, na.rm=T), alpha="Erie"), 
            color="#69b3a2", size=1) +
  geom_line(data=data_huron, 
            aes(Date, MSL-mean(MSL, na.rm=T), alpha="Michigan-Huron"),
            color="#69b3a2", size=1) +
  ylab("Centered Mean Lake Level (ft)") +
  ggtitle("Centered water levels of Lake Erie and Lake Michigan-Huron") +
  scale_x_date(breaks=date_breaks, date_labels='%Y') +
  scale_alpha_manual(name="Lake", values = c("Michigan-Huron" = 0.4, "Erie" = 1)) +
  theme(legend.position="bottom", legend.margin=margin(-10),
        plot.title=element_text(hjust=0.5))
```


------------

## Limitations

------------

## Conclusion


------------

## References  

- https://tidesandcurrents.noaa.gov/waterlevels.html
(data!)

- https://www.epa.gov/greatlakes/facts-and-figures-about-great-lakes 

- https://en.wikipedia.org/wiki/Lake_Michigan%E2%80%93Huron

- https://www.watershedcouncil.org/great-lakes-water-levels.html

